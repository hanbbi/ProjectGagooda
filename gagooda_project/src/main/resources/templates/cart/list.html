<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout.html}">
<head>
    <meta charset="UTF-8">
    <title>장바구니 목록</title>
</head>
<body>
    <div layout:fragment="content">
        <h1>장바구니 목록</h1>
        <form th:action method="get">
            <th:block th:if="${cartList.size() > 0}">
                <div>
                    <table>
                        <thead>
                        <tr>
                            <th>전체 <span th:text="${cartList.size()}"></span>개</th>
                            <th>
                                <input type="checkbox" class="allCheck" checked>
                            </th>
                            <th>상품정보</th>
                            <th>가격</th>
                            <th>수량</th>
                            <th>합계</th>
                        </tr>
                        </thead>
                        <tbody>
                        <th:block th:each="i : ${#numbers.sequence(0, cartList.size()-1)}">
                            <tr th:data-cart="${cartList[i].cartId}">
                                <td th:text="${i+1}"></td>
                                <td class="checkBox"><input type="checkbox" name="checkList" class="checkList" checked th:value="${cartList[i].cartId}"></td>
                                <td>
                                    <img th:src="@{'/img/product/{file}'(file=${cartList[i].product.getImgCode() +'_1.png'})}"
                                         style="width: 100px;">
                                    <a th:href="@{'/product/{productCode}/detail.do'(productCode=${cartList[i].getProductCode()})}" th:text="${cartList[i].getOptionProduct().getOpname()}"></a>
                                </td>
                                <td>
                                    <input type="number" th:value="${cartList[i].optionProduct.getPrice()}" readonly style="width: 100px">
                                </td>
                                <td class="cntUpdate">
                                    <input type="number" th:value="${cartList[i].cnt}" name="cntText" class="cntText" style="width: 50px">
                                </td>
                                <td>
                                    <input type="number"  th:value="${cartList[i].getOptionProduct().getPrice()*cartList[i].cnt}" class="priceList" readonly style="width: 100px">
                                </td>
                            </tr>
                        </th:block>
                        </tbody>
                    </table>
                </div>

                <div>
                    <div>총 주문금액: <strong id="totalPrice" class="totalPrice" th:text="${totalPrice}"></strong> 원</div>
                    <div>총 주문수량: <strong id="totalCnt" class="totalCnt" th:text="${totalCnt}"></strong> 개</div>
                    <button type="button" class="orderOneBtn" onclick="orderOne()">선택주문</button>
                    <button type="button" class="orderAllBtn" onclick="orderAll()">전체주문</button>
                    <button type="button" class="delOneBtn" onclick="cartDelOne()">선택삭제</button>
                    <button type="button" class="delAllBtn" onclick="cartDelAll()">전체삭제</button>
                </div>
            </th:block>
            <th:block th:if="${cartList.size() == 0}">
                <span>장바구니가 비었습니다.</span>
            </th:block>

        </form>

    </div>
</body>
</html>

<script>
    const totalPrice = document.querySelector(".totalPrice");
    const totalCnt = document.querySelector(".totalCnt");
    const priceList = document.querySelectorAll(".priceList");
    const cntTextList = document.querySelectorAll(".cntText");

    const allCheck = document.querySelector(".allCheck");
    const checkList = document.querySelector(".checkList");
    const list = document.querySelectorAll(".checkList");

    function changeEvent() {
        let total = 0;
        let cnt = 0;

        for (var i=0; i<list.length; i++) {
            if (list[i].checked) {
                total += parseInt(priceList[i].value);
                cnt += parseInt(cntTextList[i].value);
            }
        }
        totalPrice.innerText = `${total}`;
        totalCnt.innerText = `${cnt}`;
    }

    allCheck.onclick = () => {
        if (allCheck.checked) {
            for (let i=0; i<list.length; i++) {
                list[i].checked = true;
            }
        } else {
            for (let j=0; j<list.length; j++) {
                list[j].checked = false;
            }
        }
        changeEvent();
    }

    document.querySelectorAll('.checkBox').forEach((item) => (
        item.querySelector('.checkList').onclick = () => {
            allCheck.checked = false;
            changeEvent();
        }
    ))

    document.querySelectorAll('.cntUpdate').forEach((item) => (
        item.querySelector('input[name="cntText"]').onchange = () => {
            if (item.querySelector('input[name="cntText"]') != "") cartUpdate();
            changeEvent();
        })
    )


    function cartUpdate() {
        const query = 'input[name="cntText"]'
        const selectedElements = document.querySelectorAll(query)

        const selectedElementsCnt = selectedElements.length;

        const arr = new Array(selectedElementsCnt);

        document.querySelectorAll('input[name="cntText"]').forEach(function(v, i) {
            arr[i] = v.value;
        });

        const form = document.createElement('form');
        form.setAttribute('method', 'post');
        form.setAttribute('action', '/cart/user_yes/mypage/update.do');

        var input1 = document.createElement('input');
        input1.setAttribute("type", "hidden");
        input1.setAttribute("name", "cartCnts");
        input1.setAttribute("value", arr);
        form.appendChild(input1);
        document.body.appendChild(form);
        form.submit();
    }

    function cartDelAll() {
        const query = 'input[name="checkList"]'
        const selectedElements = document.querySelectorAll(query)

        const selectedElementsCnt = selectedElements.length;

        if (selectedElementsCnt == 0) {
            alert("삭제할 항목이 없습니다.");
            return false;
        } else {
            if (confirm("정말로 전체삭제하시겠습니까?")) {
                const form = document.createElement('form');
                form.setAttribute('method', 'post');
                form.setAttribute('action', '/cart/user_yes/mypage/deleteAll.do');
                document.body.appendChild(form);
                form.submit();
                changeEvent();
            }
        }
    }

    function cartDelOne() {
        const query = 'input[name="checkList"]:checked'
        const selectedElements = document.querySelectorAll(query)

        const selectedElementsCnt = selectedElements.length;

        if (selectedElementsCnt == 0) {
            alert("삭제할 항목을 선택해주세요.");
            return false;
        } else {
            if (confirm("정말로 삭제하시겠습니까?")) {
                //배열생성
                const arr = new Array(selectedElementsCnt);

                document.querySelectorAll('input[name="checkList"]:checked').forEach(function(v, i) {
                    arr[i] = v.value;
                });

                const form = document.createElement('form');
                form.setAttribute('method', 'post');        //Post 메소드 적용
                form.setAttribute('action', '/cart/user_yes/mypage/deleteOne.do');

                var input1 = document.createElement('input');
                input1.setAttribute("type", "hidden");
                input1.setAttribute("name", "cartIds");
                input1.setAttribute("value", arr);
                form.appendChild(input1);
                console.log(form);
                document.body.appendChild(form);
                form.submit();
                changeEvent();
            }
        }
    }

    function orderOne() {
        const query = 'input[name="checkList"]:checked';
        const selectedElements = document.querySelectorAll(query);
        const selectedElementsCnt = selectedElements.length;

        if (selectedElementsCnt == 0) {
            alert("주문할 상품이 없습니다.");
            return false;
        } else {
            const arr = new Array(selectedElementsCnt);

            document.querySelectorAll('input[name="checkList"]:checked').forEach(function(v, i) {
                arr[i] = v.value;
            });

            const form = document.createElement('form');
            form.setAttribute('method', 'get');        //Post 메소드 적용
            form.setAttribute('action', '/order/user_yes/register.do');

            var input1 = document.createElement('input');
            input1.setAttribute("type", "hidden");
            input1.setAttribute("name", "orderCartIds");
            input1.setAttribute("value", arr);
            form.appendChild(input1);
            console.log(form);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function orderAll() {
        const query = 'input[name="checkList"]'
        const selectedElements = document.querySelectorAll(query)
        const selectedElementsCnt = selectedElements.length;

        if (selectedElementsCnt == 0) {
            alert("주문할 상품이 없습니다.");
            return false;
        } else {
            allCheck.checked = true;

            for (let i=0; i<list.length; i++) {
                list[i].checked = true;
            }

            const arr = new Array(selectedElementsCnt);

            document.querySelectorAll('input[name="checkList"]:checked').forEach(function(v, i) {
                arr[i] = v.value;
            });

            const form = document.createElement('form');
            form.setAttribute('method', 'get');        //Post 메소드 적용
            form.setAttribute('action', '/order/user_yes/register.do');

            var input1 = document.createElement('input');
            input1.setAttribute("type", "hidden");
            input1.setAttribute("name", "orderCartIds");
            input1.setAttribute("value", arr);
            form.appendChild(input1);
            console.log(form);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>