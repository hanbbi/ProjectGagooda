<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/mypageLayout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>
<div layout:fragment="myPageContent">
<h2>유저 환불 목록</h2>
<span class="currentPeriod" th:text="${param.period}" style="display: none"></span>

<ul>
    <li><a href="/refund/user_yes/mypage/list.do">유저 환불 목록(로그인!!!)</a></li>
    <li><a th:href="@{ '/refund/user_yes/mypage/{orderId}/register.do' (orderId='00010') }">유저 환불 등록폼(로그인 후 가능!)</a></li>
    <li><a th:href="@{ '/refund/user_yes/mypage/{refundId}/detail.do' (refundId=1) }">유저 환불 상세 페이지(로그인 후 가능!)</a></li>
    <li><a href="/refund/admin/list.do">관리자 리스트(로그인)</a></li>
    <li><a href="/refund/admin/1/detail.do">관리자 상세(로그인)</a></li>
    <li><a th:href="@{'/refund/user_yes/{orderId}/payments/temp.do' (orderId='00010')}">임시 결제 창(로그인)</a></li>
    <li><a href="/order/user_yes/register.do">주문 등록</a></li>
</ul>


<div class="d-flex justify-content-between nav-tabs" >
    <ul class="nav">
        <!-- 기간 선택 조회-->
        <li class="nav-item"><a class="nav-link afterParam" href="javascript:void(0)" data-val="7">7일</a></li>
        <li class="nav-item"><a class="nav-link afterParam" href="javascript:void(0)" data-val="15">15일</a></li>
        <li class="nav-item"><a class="nav-link afterParam" href="javascript:void(0)" data-val="30">1개월</a></li>
        <li class="nav-item"><a class="nav-link afterParam" href="javascript:void(0)" data-val="90">3개월</a></li>
        <li class="nav-item"><a class="nav-link afterParam" href="javascript:void(0)" data-val="365">1년</a></li>
        <!-- 기간 선택 조회 end-->
    </ul>
    <!-- 기간 검색 조회-->
    <form  th:action="@{ '' }" method="get" class="d-flex align-self-end" style="height: 40px;">
        <input class="form-control" type="date" name="startDate" id="startDate" required>
        <span class="mx-2" style="line-height: 40px;"><i class="bi bi-dash"></i></span>
        <input class="form-control" type="date" name="endDate" id="endDate" required>
        <button class="btn btn-outline-secondary mx-1" type="submit"><i class="bi bi-search"></i></button>
    </form>
    <!-- 기간 검색 조회 end-->
</div>
    <ul class="nav">
        <!--공통 코드별(진행:rf0,rf2,rf3,rf4,rf5,rf6 / 완료:rf1,rf7,rf8) 선택 조회-->
        <li class="nav-item"><a class="nav-link afterCode" href="javascript:void(0)"  data-val="all">전체 환불 내역</a></li>
        <li class="nav-item"><a class="nav-link afterCode" href="javascript:void(0)" data-val="notEnd">환불 진행 내역</a></li>
        <li class="nav-item"><a class="nav-link afterCode" href="javascript:void(0)" data-val="end">환불 완료 내역</a></li>
        <!--공통 코드별(진행:rf0,rf2,rf3,rf4,rf5,rf6 / 완료:rf1,rf7,rf8) 선택 조회 end-->
        <li class="nav-link disabled">( 총 <th:block th:text="${userRefundCount}"></th:block> 건)</li>
    </ul>

<table class="table table-hover">
    <th:block th:if="${refundMsg != null}">
        <span id="msg" th:data-msg="${refundMsg}"></span>
        <div class="alert alert-primary" role="alert" th:text="${refundMsg}"></div>
    </th:block>
    <thead>
        <tr>
            <th scope="col">환불 요청 날짜</th>
            <th scope="col">주문번호</th>
            <th scope="col">상품명</th>
            <th scope="col">환불 금액</th>
            <th scope="col">처리 현황</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="refund:${refundList}" class="hrefRow" th:data-refund="${refund.refundId}" style="cursor: pointer">
            <td scope="row" th:text="${#calendars.format(refund.regDate,'yyyy-MM-dd')}"></td>
            <td th:text="${refund.orderId}"></td>
            <td th:text="${refund.orderDetailDto.optionName}"></td>
            <td th:text="${refund.cancelAmount}"></td>
            <td th:text="${rfDetList[#strings.substring(refund.rfDet,2)].detName}"></td>
        </tr>
    </tbody>
</table>
<th:block th:if="${userRefundCount == 0}">
    <h3>환불 내역이 없습니다.</h3>
</th:block>

<!--pagination-->
<nav aria-label="Page navigation">
    <ul class="pagination">
        <li class="page-item">
            <a class="page-link" th:href="@{${paging.queryString}(page=${paging.prevPage})}" th:classappend="${(paging.page==1)?'disabled':''}">Previous</a>
        </li>
        <li class="page-item">
            <a class="page-link" th:href="@{${paging.queryString}(page=${paging.nextPage})}" th:classappend="${(!(paging.next))?'disabled':''}">Next</a>
        </li>
    </ul>
</nav>
<!--pagination end--------------->

    <nav class="m-1 d-flex justify-content-center">
        <ul class="pagination">
            <li class="page-item" th:classappend="${(!paging.prev)?'disabled':''}">
                <a class="page-link" th:href="@{${paging.queryString}(page=${paging.prevPage})}">Prev</a></li>
            <th:block th:if="${paging.startPage>1}">
                <li>
                    <a th:href="@{${paging.queryString}(page=1)}">1</a>
                </li>
                <li class="disabled"><span>…</span></li>
            </th:block>

            <li class="page-item" th:each=" i : ${#numbers.sequence(paging.startPage,paging.endPage)}"
                th:classappend="${(i==paging.page)?'disabled':''}">
                <a class="page-link" th:classappend="${(i==paging.page)?'text-primary fw-bold':''}"
                   th:href="@{${paging.queryString}(page=${i})}" th:text="${i}"></a>
            </li>
            <th:block th:if="${paging.endPage<paging.totalPages}">
                <li class="disabled"><span>…</span></li>
                <li class="page-item">
                    <a class="page-link" th:href="@{${paging.queryString}(page=${paging.totalPages})}"
                       th:text="${paging.totalPages}"></a>
                </li>
            </th:block>
            <li class="page-item" th:classappend="${(!paging.next)?'disabled':''}">
                <a class="page-link" th:href="@{${paging.queryString}(page=${paging.nextPage})}">Next</a></li>
        </ul>
    </nav>

<script th:inline="javascript">
    let hrefRows = document.querySelectorAll(".hrefRow");
    hrefRows.forEach((row)=>{
        row.addEventListener('click',()=>{
            console.log(row)
            let targetHref = "http://"+ document.location.host + "/refund/user_yes/mypage/"+ row.dataset.refund+"/detail.do";
            console.log(targetHref)
            document.location.href =  targetHref;
        })
    })
    const afterParam = document.querySelectorAll(".afterParam");
    let period = document.querySelector(".currentPeriod").innerText;
    let url = document.location.href;
    afterParam.forEach(param=>{
        let period = "period="+[[${param.period}]];
        let value = [[${param.period}]]
        if (param.dataset.val == value){
            console.log(period)
            param.classList.add("active");
        }else{
        }
    });
    afterParam.forEach((param)=>{
        param.addEventListener("click", ()=>{
            if (url.includes("?")){
                if(url.includes("startDate") && url.includes("endDate")){
                    url = url.replace("startDate="+[[${param.startDate}]]+"&endDate="+[[${param.endDate}]],"");
                }
                if (url.includes("period")){
                    document.location.href = url.replace("period="+[[${param.period}]], "period="+param.dataset.val);
                }else{
                    document.location.href = url + "&period="+param.dataset.val;
                }
            }else{
                document.location.href = document.location.href + "?period=" + param.dataset.val;
            }
        })
    })

    let afterCode = document.querySelectorAll(".afterCode");
    afterCode.forEach(code=>{
        code.addEventListener("click",()=>{
            if (url.includes("?")){
                if (url.includes("detCode")){
                    document.location.href = url.replace("detCode="+[[${param.detCode}]], "detCode="+code.dataset.val);
                }else{
                    document.location.href = url + "&detCode="+code.dataset.val;
                }
            }else{
                document.location.href = document.location.href + "?detCode=" + code.dataset.val;
            }
        })
    })
</script>
</div>
</html>