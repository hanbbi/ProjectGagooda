<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/mypageLayout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<div layout:fragment="content">
<div>
    <h1>환불 반품 신청서</h1>
    <a href="#">엑스(주문 상세 페이지로 이동)</a>
</div>
    <th:block th:if="${refundMsg !=null}">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong th:text="${session.loginUser.uname} + 님."></strong>
            <p th:text="${refundMsg}"></p>
            <p><span th:text="${order.orderId}"></span> 번 주문에 대한 환불 요청이 <strong th:text="${refundCount}"></strong> 건 검색됩니다. </p>
            <p>해당 주문에 대한 상세 물품이 이미 환불 진행중이라면, 전체 환불은 등록되지 않습니다. </p>
            <p>환불 요청이 없음에도 등록이 진행되지 않는다면, 고객센터에 문의해주십시오.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </th:block>

<h2>환불 반품 신청</h2>
<h3>주문 정보</h3>
<div>주문인: <span th:text="${order.userName}"></span></div>
<div>주문날짜: <span th:text="${#calendars.format(order.regDate, 'yyyy-MM-dd') }"></span></div>
<div>주문번호: <span th:text="${order.orderId}"></span></div>
<div>주문 상품명: <span th:text="${order.orderDetailList[0].optionName}+' 외 '+ ${order.orderDetailList.size() -1} + '건'"></span></div>
<div>주문 총 금액: <span th:text="${order.totalPrice}"></span></div>


<form th:action="@{'{orderId}' (orderId = ${order.orderId})}" method="post">
    <input type="hidden" id="userId" name="userId" th:value="${order.userId}">
    <input type="hidden" id="uname" name="uname" th:value="${order.userName}">
    <input type="hidden" id="email" name="email" th:value="${order.userEmail}">
    <input type="hidden" id="phone" name="phone" th:value="${order.userPhone}">
<!--    <input type="hidden" id="orderId" name="orderId" th:value="${order.orderId}">-->
    <fieldset>
        <legend>환불 정보</legend>
        <div>
            <label for="orderDetailId">환불 대상 상품</label>
            <select name="orderDetailId" id="orderDetailId" onchange="changeOpt()" required>
                <option value="" selected disabled>환불 대상을 선택해주세요.</option>
                <option value="-1" th:text="'전체 환불'+'( 환불 금액:' + ${order.totalPrice} + ')'"></option>
                <th:block th:each="orderDetail : ${order.orderDetailList}">
                <option th:text="${orderDetail.optionName+'( 환불 금액:'+orderDetail.price+')'}" th:value="${orderDetail.orderDetailId}"></option>
                </th:block>
            </select>
        </div>
        <div>
            <label for="cancelAmount">환불 금액</label>
            <input type="text" id="cancelAmount" name="cancelAmount">
        </div>
        <div>
            <label for="imgCode">첨부 이미지</label>
            <input type="file" id="imgCode" name="imgCode">
        </div>
        <div>
            <label for="rfrDet">환불 사유 카테고리</label>
            <select name="rfrDet" id="rfrDet" required>
                <option value="" selected disabled>요청 유형을 선택해주세요.</option>
                <option value="rfr0">단순 변심</option>
                <option value="rfr1">상품 문제</option>
                <option value="rfr2">배송 문제</option>
                <option value="rfr3">기타</option>
            </select>
        </div>
        <div>
            <label for="reason">상세 환불 사유</label>
            <textarea id="reason" name="reason" placeholder="환불 사유를 작성해주세요."></textarea>
        </div>
    </fieldset>

    <fieldset>
        <legend>환불 물품 수거지 주소</legend>
        <div>
            <div>
                <select id="myAddressList" onchange="changeAdd()">
                    <option value="" disabled selected>내 배송지 목록</option>
                    <th:block th:if="${addressList != null}" th:each="address:${addressList}">
                        <option th:value="${address.addressId}" th:text="${address.aname}" th:data-address="${address}"></option>
                    </th:block>
                </select>
            </div>
            <div>
                <a href="#">새 배송지 입력</a>
            </div>
        </div>
        <th:block>

        </th:block>
        <input type="hidden" id="addressId" name="addressId" class="add" th:value="${order.addressId}">
        <div>
            <label for="postCode">우편 번호</label>
            <input type="text" id="postCode" name="postCode" class="add" th:value="${order.postCode}">
        </div>
        <div>
            <label for="address">주소</label>
            <input type="text" id="address" name="address" class="add" th:value="${order.address}">
        </div>
        <div>
            <label for="addressDetail">상세 주소</label>
            <input type="text" id="addressDetail" name="addressDetail" class="add" th:value="${order.addressDetail}">
        </div>
        <div>
            <label for="receiverName">수령인 이름</label>
            <input type="text" id="receiverName" name="receiverName" class="add" th:value="${order.receiverName}">
        </div>
        <div>
            <label for="receiverPhone">수령인 전화번호</label>
            <input type="text" id="receiverPhone" name="receiverPhone" class="add" th:value="${order.receiverPhone}" >
        </div>
        <div>
            <label for="elevator">엘리베이터 유무</label>
            <input type="text" id="elevator" name="elevator" class="add" th:value="${order.elevator}">
        </div>
        <script th:inline="javascript">
            let cancelAmount = document.querySelector("#cancelAmount");
            function changeOpt(){
                console.log(document.getElementById("orderDetailId"));
                let changeSelect = document.getElementById("orderDetailId");
                let optVal = changeSelect.options[changeSelect.selectedIndex].value;
                console.log("opt:"+optVal);
                let optTxt = changeSelect.options[changeSelect.selectedIndex].text;
                console.log("option:"+optTxt);
                cancelAmount.value = optTxt.split(":")[1].split(")")[0];
            }

            const currentAddressList = document.querySelectorAll(".add");
            function changeAdd(){
                let addressSlt = document.getElementById("myAddressList");
                // document.getElementById("addressId").value = addressSlt.options[addressSlt.selectedIndex].value;
                console.log(addressSlt.options[addressSlt.selectedIndex].dataset.address, typeof(addressSlt.options[addressSlt.selectedIndex].dataset.address) );
                let address = addressSlt.options[addressSlt.selectedIndex].dataset.address.split("(")[1].split(")")[0].split(",");
                let addressMap = new Map();
                for (let add of address){
                    let splitAdd = add.split("=");
                    console.log(splitAdd);
                    addressMap.set(splitAdd[0].trim(),splitAdd[1]);
                }
                console.log(addressMap);
                console.log(addressMap.get("addressId"));
                currentAddressList[0].value = addressMap.get("addressId");
                currentAddressList[1].value = addressMap.get("postCode");
                currentAddressList[2].value = addressMap.get("address");
                currentAddressList[3].value = addressMap.get("addressDetail");
                currentAddressList[4].value = addressMap.get("receiverName");
                currentAddressList[5].value = addressMap.get("receiverPhone");
                currentAddressList[6].value = addressMap.get("elevator");
            }

        </script>
    </fieldset>
    <button type="submit">신청하기</button>
    <button type="reset">초기화</button>
</form>

</div>
</html>